---
title: "Data Manipulation with dplyr"
author: "li zongzhang"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    toc: yes
    toc_float: no
    number_sections: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,comment="")
```

```{r data, include = FALSE}

library(dplyr)
library(ggplot2)
library(readxl)
library(knitr)
```

本节使用数据集starwars。

```{r}
#加载包dplyr
library(dplyr)
starwars

```

![](logo.png){width="30%"}

# dplyr函数概况

## dplyr函数的分类

所有的dplyr函数，第1项参数都是数据框（data frame 或者 tibble)

dplyr提供了一系列管理数据的函数，根据管理的对象不同，可以将这些函数分为对列的管理、对行的管理、对行组的管理三类。

-   列的管理 Columns:
    -   `select()` changes whether or not a column is included.
    -   `rename()` changes the name of columns.
    -   `mutate()` changes the values of columns and creates new
        columns.
    -   `relocate()` changes the order of the columns.
-   行的管理 Rows:
    -   `filter()` chooses rows based on column values.
    -   `slice()` chooses rows based on location.
    -   `arrange()` changes the order of the rows.
-   行组的管理Groups of rows:
    -   `summarise()` collapses a group into a single row.
    -   `count()`
    -   `top_n()`

## dplyr函数的共性 Commonalities

-   第1项参数是data frame.
-   第2项参数描述动作。
-   输出结果是一个新的data frame.

# 列的管理Column

## select()

-   contains()
-   starts_with()
-   ends_with()
-   last_col()
-   ?select_helpers

```{r}

#names()列出数据框所有变量名
names(starwars)

#选择需要的变量，创建新的数据框
starwars_selected <- starwars %>% select(
  name, height, mass, sex, species, films)
starwars_selected

#选择一个范围，变量名1：变量2
data1 <- starwars %>% 
       select(name:mass)
data1

#设置条件 contains()
data2 <- starwars %>% 
       select(name, species, contains("color"))
data2



```

## mutate()

在数据集中追加新的变量。

```{r}
#生成新变量
starwars_selected %>% 
  mutate(BMI = mass/((height/100)^2)) %>% 
  arrange(desc(BMI))
starwars_selected

starwars_selected %>% 
  mutate(wt_rank = min_rank(desc(mass))) %>% 
  arrange((wt_rank)) 

#overwrite the variable
starwars_selected %>% 
  mutate(height = height/100) %>% 
  arrange(desc(height))

#everything() selects all variable.
starwars %>%
  mutate(height_m = height / 100) %>%
  select(height_m, height, everything())
```

## rename()

```{r}
#重命名变量，rename(新名=旧名)
starwars_selected %>% 
  rename(weight = mass)

#在select 的时候重命名
data3 <- starwars %>% 
  select(name, height, weight = mass)
data3
```

## transmute()

transmute()是select()和mutate()的结合。

Transmute is like a combination of select and mutate: you are getting
back just a subset of the columns, but you are transforming and changing
them at the same time.

```{r}
data4 <- starwars %>% 
  filter(height != "NA") %>% 
  transmute(name, height, mass, bmi = mass/((height/100)^2))
data4
```

## relocate()

调整列的排列顺序。

```{r}
starwars %>% relocate(sex:homeworld, .before = height)
starwars

starwars %>% 
  select(name, species, everything())
starwars
```

## if_else()

对变量值进行条件转换。

```{r}
#加载包tidyr，drop_na()属于包tidyr
library(tidyr)
size_of_weight <- starwars_selected %>% 
  drop_na(mass) %>% 
  mutate(weight_size = if_else(mass >100, 
                               "large",
                               "small"))
size_of_weight
```

## recode()

对变量值进行重新编码。

```{r}
# overwrite the original variable.
size_of_weight %>% 
  mutate(weight_size = recode(weight_size,
                              "large" =1,
                              "small" =2))
size_of_weight
```

## duplicated()

```{r}
# Create a Data Frame
df6 <- data.frame(x1 = c(1:5),
                    x2 = letters[1:5],
                    x3 = seq(2,10,2),
                    x1 = LETTERS[22:26],
                    check.names = FALSE)
df6

# Find Duplicate Column Names
duplicated_names <- duplicated(colnames(df6))

# Remove Duplicate Column Names
df6[!duplicated_names]
```

## as.factor()

将字符串转换为因子。

```{r}
starwars_selected %>% 
  mutate(vore = as.factor(species)) %>% 
  glimpse()
```

# 行的管理Rows

## arrange()

将个案按某个变量排序。

```{r}
#升序
starwars_selected %>% arrange(height)

#降序 desc()
starwars_selected %>% 
  arrange(desc(height))

# 查看前6行
head(starwars_selected)
# see a few values from all the columns
glimpse(starwars_selected)
```

## filter()

提取满足条件的个案。

```{r}
#列出变量的取值种类
unique(starwars$species)

#提取species == "Droid"的个案
starwars_selected %>% 
  filter(species == "Droid") %>% 
  arrange(height) 


#提取height < 200的个案
starwars_selected %>% 
  arrange(desc(height)) %>% 
  filter(height < 200)

#用逗号分隔多个提取条件
starwars_selected %>% 
    filter(height < 200, species == "Human")  %>% 
    arrange(desc(height))
starwars_selected

starwars_selected %>% 
    filter((species == "Human"|species == "Droid") & 
         height < 200 ) %>% 
    arrange(desc(height))
starwars_selected

#%in% 属于
starwars_selected %>% 
    filter((species %in% c("Human","Droid")) & 
         height < 200 ) %>% 
    arrange(desc(height)) 
starwars_selected

#filter(!is.na(height))保留height没有缺失值的个案
starwars_selected %>% 
  arrange(desc(height)) %>% 
  filter(!is.na(height))
```

## slice()

slice() lets you index rows by their (integer) locations. It allows you
to select, remove, and duplicate rows.

slice_min() and slice_max() select rows with highest or lowest values of
a variable.

```{r}
#提取第5到第10行
starwars %>% slice(5:10)
#提取前3行
starwars %>% slice_head(n = 3)
#提取后3行
starwars %>% slice_tail(n = 3)
#随机抽样3行
starwars %>% slice_sample(n = 5)
#随机抽样比例0.1
starwars %>% slice_sample(prop = 0.1)
#切取某个变量最大或最小的几个个案
starwars %>%
  filter(!is.na(height)) %>%
  slice_max(height, n = 3)
```

## distinct()

剔除重复的行。

```{r}
## 剔除所有列的值都相同的行
df4 <- data.frame(ID =c(1,2,3,4,2),
                  name = c("John","Bill","Jim","Kate", "Bill"))
df4
df4 <- distinct(df4)
df4
```

```{r}
## 剔除某一列的值相同的行
df5 <- data.frame(ID =c(1,2,3,4,2),
                  name = c("John","Bill","Jim","Kate", "Alex"))
df5
df5 <- distinct(df5, ID,.keep_all = TRUE)
df5

unique(df4)
```

# 分组和概要 groupby and summarize

## count()

The simple way you can aggregate data is to count it: to find out the
number of observations.

```{r}
starwars %>% 
  count()

#按性别计数
starwars %>% 
  count(sex)

#计数和排序
starwars %>% 
  count(sex, sort = TRUE)

#按性别分组，各组个案的体重之和
starwars %>% 
  count(sex, wt = mass, sort = TRUE)

```

## group_by()

对个案分组。

## summarize()

summarise() and summarize() are synonyms.

summary functions

-   sum()
-   mean()
-   median()
-   min()
-   max()
-   n()

```{r}
starwars_selected %>% 
  filter(height != "NA", mass != "NA", sex != "NA") %>% 
  group_by(sex) %>% 
  summarize(number = n(), median_height = median(height), 
            median_weight = median(mass)) %>% 
  arrange(desc(number))
```

## top_n()

```{r}
starwars_selected %>% 
  filter(height != "NA", mass != "NA", sex != "NA") %>% 
  group_by(sex) %>% 
  top_n(1,height)

starwars_selected %>% 
  filter(height != "NA", mass != "NA", sex != "NA") %>% 
  group_by(sex) %>% 
  top_n(2,mass) %>% 
  arrange(sex)
```

## 缺失值 Missing data

```{r}
#有missing data, 无法计算均值
mean(starwars$height)

mean(starwars$height,na.rm = TRUE)

starwars %>% 
  select(name, gender, hair_color, height) %>% 
  na.omit()
starwars

# 查看有缺失值的个案
starwars %>% 
  select(name, gender, hair_color, height) %>% 
  filter(!complete.cases(.)) 
starwars

starwars %>% 
  select(name, gender, hair_color, height) %>% 
  filter(!complete.cases(.)) %>% 
  drop_na(height)
starwars


starwars %>% 
  select(name, gender, hair_color, height) %>% 
  filter(complete.cases(.)) %>% 
  mutate(hair_color2 = replace_na(hair_color, "none"))
starwars         
```

# 总结

![](%E6%88%AA%E5%B1%8F2022-04-15%2000.38.23.png){width="60%"}

These five functions provide the basis of a language of data
manipulation.

-   reorder the rows (arrange())
-   pick observations and variables of interest (filter() and select())
-   add new variables that are functions of existing variables
    (mutate())
-   collapse many values to a summary (summarise()).

## 本章作业

数据集：mpg {ggplot2}

1.  用select()函数从mpg提取5个变量⽣成新的数据框。

2.  用mutate()函数在数据框中追加新的变量，将油耗变量cty和hwy（miles
    per gallon）转换成转公里/升(kilometers per liter)的油耗指标。

3.  任选mpg中的某个变量，用if_else()函数对该变量的数值进⾏条件转换。

4.  设置三个筛选条件，用filter()函数从mpg筛选个案⽣成新的数据框。

5.  提交要求：R script
